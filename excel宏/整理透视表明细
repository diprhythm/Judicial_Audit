Option Explicit

Sub 整理透视表()
    Dim ws As Worksheet
    Dim cell As Range, hdrCell As Range, rng As Range
    Dim arrKeywords As Variant, keyword As Variant
    Dim headerText As String
    Dim foundCol As Long, lastRow As Long
    Dim dateCol As Range, c As Range

    ' —— 性能开关 ——
    With Application
        .ScreenUpdating = False
        .EnableEvents = False
        .Calculation = xlCalculationManual
    End With

    Set ws = ActiveSheet

    ' —— 1. 如果是表格，先转成普通区域 ——
    If ws.ListObjects.Count > 0 Then
        ws.ListObjects(1).Unlist
    End If

    ' —— 2. 清除格式（仅限 usedrange，加快速度） ——
    With ws.UsedRange
        .Interior.Pattern = xlNone
        .Borders.LineStyle = xlNone
    End With

    ' —— 3. 关键词列表 ——
    arrKeywords = Array( _
        "序号（唯一）", "】类别", "初步1", "索引号", "[年月日]", _
        "收入", "支出", "净流", "[余额]", "对手户名", _
        "对手开户行", "币种", "对手账/卡号", "【摘要类】", _
        "取得状态", "已取序号", "工商" _
    )

    ' —— 4. 第三行常量单元格加样式 ——
    On Error Resume Next
    Set rng = ws.Rows(3).SpecialCells(xlCellTypeConstants)
    On Error GoTo 0
    If rng Is Nothing Then
        MsgBox "第三行没有常量，无法继续。", vbInformation
        GoTo Cleanup
    End If
    With rng
        .Interior.Color = 11711154
        .Font.Color = vbBlack
        .WrapText = True
        .HorizontalAlignment = xlCenter
        .VerticalAlignment = xlCenter
    End With

    ' ? 设置第三行行高为 25
    ws.Rows(3).RowHeight = 25

    ' —— 5. 遍历第三行：截断表头、分组/列宽、SUBTOTAL、着色 ——
    For Each cell In rng
        headerText = Trim(cell.Value)
        If InStr(headerText, "[") > 0 Then
            headerText = Mid(headerText, InStr(headerText, "["))
            cell.Value = headerText
        End If

        ' 关键词匹配：如果命中就设宽度，否则分组
        Dim matched As Boolean: matched = False
        For Each keyword In arrKeywords
            If InStr(headerText, keyword) > 0 Then
                cell.EntireColumn.ColumnWidth = 10
                matched = True
                Exit For
            End If
        Next
        If Not matched Then
            ws.Columns(cell.Column).Group
        End If

        ' 财务列：Comma 样式 + SUBTOTAL
        If headerText Like "*收入*" Or headerText Like "*支出*" _
           Or headerText Like "*净流*" Or headerText Like "*余额*" Then

            With cell.EntireColumn
                .Style = "Comma"
                .AutoFit
            End With
            lastRow = ws.Cells(ws.Rows.Count, cell.Column).End(xlUp).Row
            If lastRow > 3 Then
                ws.Cells(2, cell.Column).Formula = _
                    "=SUBTOTAL(9," & ws.Cells(4, cell.Column).Address & _
                    ":" & ws.Cells(lastRow, cell.Column).Address & ")"
            End If
        End If

        ' 其它关键词着色
        Select Case True
            Case InStr(headerText, "初步") > 0, InStr(headerText, "】类别") > 0
                cell.Interior.Color = 15773696
            Case InStr(headerText, "账户类别") > 0, InStr(headerText, "币种") > 0
                cell.Interior.Color = 5296274
                cell.EntireColumn.ColumnWidth = 5
            Case InStr(headerText, "取得状态") > 0, InStr(headerText, "已取序号") > 0
                cell.Interior.Color = 65535
            Case InStr(headerText, "延伸") > 0
                cell.Interior.Color = 16751001
            Case InStr(headerText, "工商") > 0
                cell.Interior.Color = 5287936
        End Select
    Next

    ' —— 6. 展开分组、插入空行、冻结前三行 & 筛选 ——
    ws.Outline.ShowLevels RowLevels:=0, ColumnLevels:=1
    ws.Rows(4).Insert Shift:=xlDown
    ws.Rows(3).AutoFilter
    ws.Range("A4").Select
    ActiveWindow.FreezePanes = True

    ' —— 7. 精确查找 “[日期]” 列 ——
    foundCol = 0
    For Each hdrCell In ws.Rows(3).Cells
        If VarType(hdrCell.Value) = vbString Then
            If StrComp(Trim(hdrCell.Value), "[日期]", vbTextCompare) = 0 Then
                foundCol = hdrCell.Column
                Exit For
            End If
        End If
    Next
    If foundCol = 0 Then
        MsgBox "未找到 “[日期]” 列头。", vbExclamation
        ws.Rows(4).Delete
        GoTo Cleanup
    End If

    ' —— 8. 日期转换 & 格式 ——
    lastRow = ws.Cells(ws.Rows.Count, foundCol).End(xlUp).Row
    For Each c In ws.Range(ws.Cells(4, foundCol), ws.Cells(lastRow, foundCol))
        If IsDate(c.Value) Then c.Value = CDate(c.Value)
    Next
    ws.Columns(foundCol).NumberFormat = "yyyy/mm/dd hh:MM:ss"

    ' —— 9. 升序排序 ——
    With ws.Sort
        .SortFields.Clear
        .SortFields.Add key:=ws.Columns(foundCol), _
            SortOn:=xlSortOnValues, Order:=xlAscending
        .SetRange ws.Range( _
            ws.Cells(4, 1), _
            ws.Cells(lastRow, ws.Columns.Count).End(xlToLeft) _
        )
        .Header = xlYes
        .Apply
    End With

    ' —— 10. 删除空行 ——
    If WorksheetFunction.CountA(ws.Rows(4)) = 0 Then
        ws.Rows(4).Delete
    End If

Cleanup:
    ' —— 恢复环境 ——
    With Application
        .ScreenUpdating = True
        .EnableEvents = True
        .Calculation = xlCalculationAutomatic
    End With
End Sub

