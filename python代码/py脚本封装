import os
import subprocess
import sys
import shutil


def install_pyinstaller():
    try:
        import PyInstaller
    except ImportError:
        print("æœªæ£€æµ‹åˆ° PyInstallerï¼Œæ­£åœ¨è‡ªåŠ¨å®‰è£…...")
        subprocess.check_call([sys.executable, "-m", "pip", "install", "pyinstaller"])


def build_exe(py_file_path):
    py_file_path = os.path.abspath(py_file_path)

    if not os.path.isfile(py_file_path):
        print("âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°æŒ‡å®šçš„ .py æ–‡ä»¶ã€‚è¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®ã€‚")
        return

    os.chdir(os.path.dirname(py_file_path))
    file_name = os.path.basename(py_file_path)
    exe_name = os.path.splitext(file_name)[0]

    print(f"ğŸš€ æ­£åœ¨å°è£…ï¼š{file_name} -> {exe_name}.exe")

    cmd = [
        "pyinstaller",
        "--onefile",
        "--clean",
        file_name
    ]
    subprocess.call(cmd)

    dist_path = os.path.join("dist", f"{exe_name}.exe")
    final_exe_path = os.path.join(os.getcwd(), f"{exe_name}.exe")

    if os.path.exists(dist_path):
        shutil.move(dist_path, final_exe_path)
        print(f"âœ… æ‰“åŒ…æˆåŠŸï¼å¯æ‰§è¡Œæ–‡ä»¶ä½ç½®ï¼š{final_exe_path}")
    else:
        print("âŒ æ‰“åŒ…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ PyInstaller çš„æ—¥å¿—ã€‚")

    # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
    for folder in ["build", "dist", "__pycache__"]:
        if os.path.exists(folder):
            shutil.rmtree(folder)
    spec_file = f"{exe_name}.spec"
    if os.path.exists(spec_file):
        os.remove(spec_file)


if __name__ == "__main__":
    install_pyinstaller()

    print("è¯·è¾“å…¥ä½ è¦æ‰“åŒ…çš„ .py æ–‡ä»¶å®Œæ•´è·¯å¾„ï¼Œä¾‹å¦‚ï¼š")
    print(r"C:\Users\Administrator\Desktop\testing1\xxx.py")
    file_path = input(">>> ").strip('"')

    if not file_path.endswith(".py"):
        print("âŒ ä½ è¾“å…¥çš„ä¸æ˜¯ .py æ–‡ä»¶è·¯å¾„ï¼Œè¯·é‡è¯•ï¼")
    else:
        build_exe(file_path)
